# Story 1.3: Test Launchd-Triggered GC

## Status

Approved

## Story

**As a** developer,
**I want** to test garbage collection when triggered by launchd,
**so that** I can reproduce the actual bug scenario.

## Acceptance Criteria

1. Force launchd service to run (simulate Sunday 00:00 trigger)
2. Verify that terminal configurations are deleted (P10k wizard appears)
3. Document permission differences between manual and launchd execution
4. Capture error logs or permission denials from launchd context
5. Confirm missing /nix/var/nix/gcroots/per-user/$USER/ directory

## Tasks / Subtasks

- [ ] Task 1: Prepare system for launchd GC test (AC: 1)
  - [ ] Ensure system is in clean state (terminal configs intact)
  - [ ] Locate the launchd plist file for nix-gc (typically in /Library/LaunchDaemons/)
  - [ ] Document the current launchd service configuration
  - [ ] Create temp/launchd-gc/ directory for test artifacts
- [ ] Task 2: Trigger launchd garbage collection (AC: 1, 4)
  - [ ] Use `sudo launchctl kickstart -k system/org.nixos.nix-gc` to force run
  - [ ] Monitor system logs with `log stream --predicate 'processImagePath CONTAINS "nix"'`
  - [ ] Capture launchd execution logs to temp/launchd-gc/launchd-output.log
  - [ ] Note any permission errors or unusual messages
- [ ] Task 3: Verify bug reproduction (AC: 2)
  - [ ] Open new terminal session immediately after GC completes
  - [ ] Document if P10k configuration wizard appears (screenshot if possible)
  - [ ] Check if ~/.config/zsh/ files are missing or corrupted
  - [ ] Test other terminal customizations (themes, plugins)
  - [ ] Record findings in temp/launchd-gc/bug-reproduced.txt
- [ ] Task 4: Analyze permission context (AC: 3, 4)
  - [ ] Compare effective permissions of launchd vs manual sudo execution
  - [ ] Check system logs for any "Operation not permitted" errors
  - [ ] Document which operations failed due to permissions
  - [ ] Create permission analysis: temp/launchd-gc/permission-analysis.txt
- [ ] Task 5: Verify GC root issue (AC: 5)
  - [ ] Check if /nix/var/nix/gcroots/per-user/$USER/ exists after GC
  - [ ] List all GC roots and compare with manual GC results
  - [ ] Document any stale roots in auto directory
  - [ ] Create GC root report: temp/launchd-gc/gc-roots-missing.txt

## Example Output Formats

### Expected Launchd Execution Output

```bash
$ sudo launchctl kickstart -k system/org.nixos.nix-gc
Service spawned with PID: 12345

# Monitoring logs in separate terminal
$ log stream --predicate 'processImagePath CONTAINS "nix"'
2025-08-12 00:00:00.123 nix-collect-garbage[12345]: Starting garbage collection
2025-08-12 00:00:01.456 nix-collect-garbage[12345]: removing old generations of profile /nix/var/nix/profiles/system
2025-08-12 00:00:02.789 nix-collect-garbage[12345]: NOTE: System-level GC runs as root, may not have access to user profiles
2025-08-12 00:00:03.012 nix-collect-garbage[12345]: error: cannot access '/Users/happygopher/.config': Operation not permitted
...
```

### Example Permission Scenarios

```bash
# Scenario 1: System-level GC (launchd runs as root)
# May not be able to access user directories due to macOS security
error: cannot access '/Users/happygopher/.config': Operation not permitted

# Scenario 2: User-level GC would show different errors
# But launchd service typically runs system-level GC only

# Note: Need to verify if launchd GC attempts to clean user profiles
```

### P10k Wizard Appearance

```bash
$ # After launchd GC completes, open new terminal
[WARNING]: Console output during zsh initialization detected.

                            Powerlevel10k Configuration Wizard

This is Powerlevel10k configuration wizard. You are seeing it because you haven't
defined any Powerlevel10k configuration options. It will ask you a few questions
and configure your prompt.

Does this look like a diamond (rotated square)?
--->  <---

(y)  Yes.
(n)  No.
(q)  Quit and do nothing.

Choice [ynq]:
```

### Launchd Service Status Check

```bash
$ sudo launchctl list | grep nix-gc
-       0       org.nixos.nix-gc

$ sudo launchctl print system/org.nixos.nix-gc
system/org.nixos.nix-gc = {
    active count = 0
    path = /Library/LaunchDaemons/org.nixos.nix-gc.plist
    state = waiting
    program = /usr/bin/nix-collect-garbage
    arguments = {
        "--delete-older-than"
        "7d"
    }
    user = root  # Confirms it runs as root
    ...
}
```

### Critical Investigation Points

```bash
# 1. Check what profiles launchd GC targets
$ cat /Library/LaunchDaemons/org.nixos.nix-gc.plist | grep -A5 ProgramArguments

# 2. Verify if it attempts user profile cleanup
$ sudo dtruss -p <gc-pid> 2>&1 | grep "per-user"  # If SIP allows

# 3. Compare with manual root GC behavior
$ sudo nix-collect-garbage --delete-older-than 7d --dry-run
```

## Dev Notes

### Critical Testing Context

**IMPORTANT**: We need to determine whether the launchd GC service:

1. Only cleans system-level profiles (`/nix/var/nix/profiles/system`)
2. Also attempts to clean user profiles (`/nix/var/nix/profiles/per-user/*`)
3. Has different permission context than manual `sudo` execution

This distinction is crucial for understanding why terminal configs get deleted.

### Important Testing Isolation Note

Consider using isolated environments to safely test without affecting the main system:

```bash
# Create test user for safe GC testing (if needed)
sudo dscl . -create /Users/testuser
# Or use nix shell for isolated testing of commands
nix shell nixpkgs#coreutils -c bash
```

### Previous Story Insights

- Story 1.1 captured the baseline working state in temp/before-gc/
- Story 1.2 tested manual GC and documented results in temp/manual-gc/
- Need to compare launchd results with both baseline and manual GC results

### Technical Analysis Reference

For comprehensive technical analysis and root cause findings, see: [`docs/ideas/nix-gc-removes-current-settings/06-summary.md`](../../ideas/nix-gc-removes-current-settings/06-summary.md)

### Testing Context

This is the critical test that should reproduce the actual bug users experience every Sunday. The PRD indicates that launchd-triggered GC behaves differently from manual GC due to permission context differences.

### Launchd Service Details

Common locations and names for nix-gc launchd service:

- `/Library/LaunchDaemons/org.nixos.nix-gc.plist`
- Service name: `system/org.nixos.nix-gc`
- Runs as root but with different permission context than interactive sudo

### Expected Bug Behavior

According to the PRD, when triggered by launchd:

- Terminal configurations in ~/.config/zsh/ will be deleted
- P10k wizard will appear on next terminal launch
- /nix/var/nix/gcroots/per-user/$USER/ directory will be missing
- Stale GC roots in auto directory may cause issues

### Permission Context Differences

Key differences between launchd and manual execution:

- launchd runs in minimal environment (limited PATH, no user session)
- Different security context even when running as root
- May not have access to user-specific directories
- SIP (System Integrity Protection) affects both but differently

### Debugging Commands

Useful commands for investigating launchd issues:

- `sudo launchctl list | grep nix` - Check service status
- `sudo launchctl print system/org.nixos.nix-gc` - Service details
- `log show --predicate 'processImagePath CONTAINS "nix"' --last 1h` - Recent logs
- `sudo dtruss -p <pid>` - Trace system calls (if SIP allows)

### Testing Standards

- Must use actual launchd triggering (not just sudo)
- Capture all logs before they rotate
- Document exact time of test execution
- Take screenshots of P10k wizard if it appears
- Preserve all error messages verbatim

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
