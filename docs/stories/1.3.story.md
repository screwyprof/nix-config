# Story 1.3: Test Launchd-Triggered GC

## Status

Ready for Review

## Story

**As a** developer,
**I want** to test garbage collection when triggered by launchd,
**so that** I can reproduce the actual bug scenario.

## Acceptance Criteria

1. Force launchd service to run (simulate Sunday 00:00 trigger)
2. Verify that terminal configurations are deleted (P10k wizard appears)
3. Document permission differences between manual and launchd execution
4. Capture error logs or permission denials from launchd context
5. Confirm missing /nix/var/nix/gcroots/per-user/$USER/ directory

## Tasks / Subtasks

- [x] Task 1: Prepare system for launchd GC test (AC: 1)
  - [x] Ensure system is in clean state (terminal configs intact)
  - [x] Locate the launchd plist file for nix-gc (typically in /Library/LaunchDaemons/)
  - [x] Document the current launchd service configuration
  - [x] Create temp/launchd-gc/ directory for test artifacts
- [x] Task 2: Trigger launchd garbage collection (AC: 1, 4)
  - [x] Use `sudo launchctl kickstart -k system/org.nixos.nix-gc` to force run
  - [x] Monitor system logs with `log stream --predicate 'processImagePath CONTAINS "nix"'`
  - [x] Capture launchd execution logs to temp/launchd-gc/launchd-output.log
  - [x] Note any permission errors or unusual messages
- [x] Task 3: Verify bug reproduction (AC: 2)
  - [x] Open new terminal session immediately after GC completes
  - [x] Document if P10k configuration wizard appears (screenshot if possible)
  - [x] Check if ~/.config/zsh/ files are missing or corrupted
  - [x] Test other terminal customizations (themes, plugins)
  - [x] Record findings in temp/launchd-gc/bug-reproduced.txt
- [x] Task 4: Analyze permission context (AC: 3, 4)
  - [x] Compare effective permissions of launchd vs manual sudo execution
  - [x] Check system logs for any "Operation not permitted" errors
  - [x] Document which operations failed due to permissions
  - [x] Create permission analysis: temp/launchd-gc/permission-analysis.txt
- [x] Task 5: Verify GC root issue (AC: 5)
  - [x] Check if /nix/var/nix/gcroots/per-user/$USER/ exists after GC
  - [x] List all GC roots and compare with manual GC results
  - [x] Document any stale roots in auto directory
  - [x] Create GC root report: temp/launchd-gc/gc-roots-missing.txt

## Example Output Formats

### Expected Launchd Execution Output

```bash
$ sudo launchctl kickstart -k system/org.nixos.nix-gc
Service spawned with PID: 12345

# Monitoring logs in separate terminal
$ log stream --predicate 'processImagePath CONTAINS "nix"'
2025-08-12 00:00:00.123 nix-collect-garbage[12345]: Starting garbage collection
2025-08-12 00:00:01.456 nix-collect-garbage[12345]: removing old generations of profile /nix/var/nix/profiles/system
2025-08-12 00:00:02.789 nix-collect-garbage[12345]: NOTE: System-level GC runs as root, may not have access to user profiles
2025-08-12 00:00:03.012 nix-collect-garbage[12345]: error: cannot access '/Users/happygopher/.config': Operation not permitted
...
```

### Example Permission Scenarios

```bash
# Scenario 1: System-level GC (launchd runs as root)
# May not be able to access user directories due to macOS security
error: cannot access '/Users/happygopher/.config': Operation not permitted

# Scenario 2: User-level GC would show different errors
# But launchd service typically runs system-level GC only

# Note: Need to verify if launchd GC attempts to clean user profiles
```

### P10k Wizard Appearance

```bash
$ # After launchd GC completes, open new terminal
[WARNING]: Console output during zsh initialization detected.

                            Powerlevel10k Configuration Wizard

This is Powerlevel10k configuration wizard. You are seeing it because you haven't
defined any Powerlevel10k configuration options. It will ask you a few questions
and configure your prompt.

Does this look like a diamond (rotated square)?
--->  <---

(y)  Yes.
(n)  No.
(q)  Quit and do nothing.

Choice [ynq]:
```

### Launchd Service Status Check

```bash
$ sudo launchctl list | grep nix-gc
-       0       org.nixos.nix-gc

$ sudo launchctl print system/org.nixos.nix-gc
system/org.nixos.nix-gc = {
    active count = 0
    path = /Library/LaunchDaemons/org.nixos.nix-gc.plist
    state = waiting
    program = /usr/bin/nix-collect-garbage
    arguments = {
        "--delete-older-than"
        "7d"
    }
    user = root  # Confirms it runs as root
    ...
}
```

### Critical Investigation Points

```bash
# 1. Check what profiles launchd GC targets
$ cat /Library/LaunchDaemons/org.nixos.nix-gc.plist | grep -A5 ProgramArguments

# 2. Verify if it attempts user profile cleanup
$ sudo dtruss -p <gc-pid> 2>&1 | grep "per-user"  # If SIP allows

# 3. Compare with manual root GC behavior
$ sudo nix-collect-garbage --delete-older-than 7d --dry-run
```

## Dev Notes

### Critical Testing Context

**IMPORTANT**: We need to determine whether the launchd GC service:

1. Only cleans system-level profiles (`/nix/var/nix/profiles/system`)
2. Also attempts to clean user profiles (`/nix/var/nix/profiles/per-user/*`)
3. Has different permission context than manual `sudo` execution

This distinction is crucial for understanding why terminal configs get deleted.

### Important Testing Isolation Note

Consider using isolated environments to safely test without affecting the main system:

```bash
# Create test user for safe GC testing (if needed)
sudo dscl . -create /Users/testuser
# Or use nix shell for isolated testing of commands
nix shell nixpkgs#coreutils -c bash
```

### Previous Story Insights

- Story 1.1 captured the baseline working state in temp/before-gc/
- Story 1.2 tested manual GC and documented results in temp/manual-gc/
- Need to compare launchd results with both baseline and manual GC results

### Technical Analysis Reference

For comprehensive technical analysis and root cause findings, see: [`docs/ideas/nix-gc-removes-current-settings/06-summary.md`](../../ideas/nix-gc-removes-current-settings/06-summary.md)

### Testing Context

This is the critical test that should reproduce the actual bug users experience every Sunday. The PRD indicates that launchd-triggered GC behaves differently from manual GC due to permission context differences.

### Launchd Service Details

Common locations and names for nix-gc launchd service:

- `/Library/LaunchDaemons/org.nixos.nix-gc.plist`
- Service name: `system/org.nixos.nix-gc`
- Runs as root but with different permission context than interactive sudo

### Expected Bug Behavior

According to the PRD, when triggered by launchd:

- Terminal configurations in ~/.config/zsh/ will be deleted
- P10k wizard will appear on next terminal launch
- /nix/var/nix/gcroots/per-user/$USER/ directory will be missing
- Stale GC roots in auto directory may cause issues

### Permission Context Differences

Key differences between launchd and manual execution:

- launchd runs in minimal environment (limited PATH, no user session)
- Different security context even when running as root
- May not have access to user-specific directories
- SIP (System Integrity Protection) affects both but differently

### Debugging Commands

Useful commands for investigating launchd issues:

- `sudo launchctl list | grep nix` - Check service status
- `sudo launchctl print system/org.nixos.nix-gc` - Service details
- `log show --predicate 'processImagePath CONTAINS "nix"' --last 1h` - Recent logs
- `sudo dtruss -p <pid>` - Trace system calls (if SIP allows)

### Testing Standards

- Must use actual launchd triggering (not just sudo)
- Capture all logs before they rotate
- Document exact time of test execution
- Take screenshots of P10k wizard if it appears
- Preserve all error messages verbatim

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

claude-opus-4-20250514

### Debug Log References

- Confirmed launchd service exits with code 1 initially, then code 0 after two-stage GC
- Captured exact chmod error: "Operation not permitted" on iTerm2.app bundle
- Verified launchd only targets root profiles: /nix/var/nix/profiles/per-user/root/*
- Discovered Home Manager uses XDG path with indirect auto root protection
- All evidence preserved in: [`docs/stories/1.3-investigation-report.md`](1.3-investigation-report.md)

### Completion Notes List

- Initial attempts: Launchd GC failed with chmod errors (exit code 1)
- BUG SUCCESSFULLY REPRODUCED with specific sequence:
  1. iTerm2 with Full Disk Access
  2. Root GC (`nix-cleanup` alias with sudo -H) - freed 10212.69 MiB
  3. Launchd GC (sudo launchctl kickstart) - exit code 0 (success)
  4. Result: P10k wizard appeared on new terminal
- Root cause: Critical Nix store path was garbage collected
  - Missing: /nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/
  - Verified this path existed before (evidence in investigation report)
- Key discovery: Home Manager uses XDG paths, not /nix/var/nix/gcroots/per-user/
- Side finding: direnv creates persistent GC roots for other projects

### File List

- Created: [`docs/stories/1.3-investigation-report.md`](1.3-investigation-report.md) - Self-contained report with all evidence, commands, outputs, and findings

## EXECUTIVE SUMMARY

**RESULT**: Bug SUCCESSFULLY REPRODUCED! The P10k wizard appeared after a specific two-stage GC sequence.

**KEY FINDINGS**:

1. **Launchd GC sometimes fails** - exits with code 1 due to chmod errors
2. **Two-stage GC triggers bug** - `nix-cleanup` (root GC) followed by launchd GC (also root) deleted configurations
3. **Full Disk Access correlation** - Bug reproduced with iTerm2 having FDA, but causation not proven
4. **Home Manager protection insufficient** - indirect GC roots don't protect all runtime dependencies

**CRITICAL DISCOVERY**: The confusion about "expected data in per-profile/happy-gopher but in fact it's in XDG" is explained:

- **Expected (wrong)**: `/nix/var/nix/gcroots/per-user/happygopher/` (traditional Nix pattern)
- **Actual (correct)**: `~/.local/state/home-manager/gcroots/current-home` (XDG-compliant)

Home Manager follows XDG Base Directory specification. While this creates indirect roots in `/nix/var/nix/gcroots/auto/`, these roots only protect the generation link, not all transitive dependencies like `/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/`.

**REPRODUCTION SEQUENCE**:

1. Root GC: `nix-cleanup` (freed 10GB from system/root profiles)
2. Launchd GC: `sudo launchctl kickstart -k system/org.nixos.nix-gc` (exit 0)
3. Result: P10k wizard on new terminal

**OPEN QUESTIONS**:

- How does Full Disk Access affect launchd services?
- Can we configure permissions for `nix-collect-garbage` in launchd?
- What exactly needs FDA: Terminal.app, /bin/sh, or the nix binary?

**For complete technical details and open questions, see**: [`docs/stories/1.3-investigation-report.md`](1.3-investigation-report.md)

## QA Results

**Date**: 2025-08-17  
**Reviewer**: Quinn (QA)

### The Good News 🎉

**We reproduced the bug!** The P10k wizard showed up just like users reported.

After several failed attempts, we found the magic combination:

1. iTerm2 with Full Disk Access enabled
2. Manual GC (`nix-cleanup`) first
3. Then launchd GC (`sudo launchctl kickstart`)
4. Boom! P10k wizard appears on new terminal

### What We Learned

- Home Manager uses XDG paths (`~/.local/state/`), not the traditional `/nix/var/nix/gcroots/per-user/`
- Launchd fails with chmod errors on .app bundles (exit code 1)
- After manual GC cleans problematic paths, launchd succeeds (exit code 0)
- The critical store path `/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/` got deleted

### Still Confused About

- Why can `sudo` chmod but launchd can't? 🤔
- What's FDA actually doing here?
- How does root-level GC delete user configs?
- Is this a macOS sandbox thing?

### Bottom Line

✅ **Story Complete!** Bug reproduced, evidence captured, ready for Story 1.4 to dig deeper.

The investigation was solid - systematic approach, great documentation, everything captured in that self-contained report. Yeah it's annoying when it happens, but it's just a 2-minute rebuild.

---
*Quinn says: Good debugging! Now someone else can figure out why macOS is being weird about permissions* 😄
