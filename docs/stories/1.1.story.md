# Story 1.1: Capture Current Working State

## Status

Ready for Review

## Story

**As a** developer,
**I want** to capture the current working terminal configuration state,
**so that** I can compare before and after GC states.

## Acceptance Criteria

1. Capture all relevant configuration files from ~/.config/zsh, ~/.cache, and XDG directories
2. Document current GC root structure in /nix/var/nix/gcroots/
3. Record current generation numbers for both system and user profiles
4. Store captured state in ./temp/ directory for comparison
5. Create checksums of critical configuration files

## Tasks / Subtasks

- [x] Task 1: Capture terminal configuration files (AC: 1, 5)
  - [x] Create temp directory structure for storing captured state
  - [x] Copy all files from ~/.config/zsh/ to temp/before-gc/config/zsh/
  - [x] Copy relevant cache files from ~/.cache/ (particularly zsh and terminal-related)
  - [x] Copy XDG configuration files from standard XDG paths
  - [x] Generate SHA256 checksums for all captured files and store in temp/before-gc/checksums.txt
- [x] Task 2: Document GC root structure (AC: 2)
  - [x] List all contents of /nix/var/nix/gcroots/ directory
  - [x] Check if /nix/var/nix/gcroots/per-user/$USER/ exists
  - [x] Document all symlinks in /nix/var/nix/gcroots/auto/
  - [x] Save complete GC root listing to temp/before-gc/gc-roots.txt
- [x] Task 3: Record generation information (AC: 3)
  - [x] Run `nix-env --list-generations` for default profile
  - [x] Run `home-manager generations` to list HM generations
  - [x] Run `darwin-rebuild --list-generations` for system generations
  - [x] Store all generation info in temp/before-gc/generations.txt
- [x] Task 4: Create comprehensive state documentation (AC: 4)
  - [x] Create README.md in temp/before-gc/ explaining the captured structure
  - [x] Include timestamp of capture
  - [x] Document the system configuration being tested (nix-darwin version, HM version)
  - [x] Note any relevant environment variables or special configurations

## Dev Notes

### Previous Story Insights

No previous story exists - this is the first story in the project.

### Technical Analysis Reference

For comprehensive technical analysis and root cause findings, see: [`docs/ideas/nix-gc-removes-current-settings/06-summary.md`](../../ideas/nix-gc-removes-current-settings/06-summary.md)

### Testing Context

This is a bug reproduction story. The goal is to systematically capture the working state before garbage collection so we can identify exactly what gets deleted during the automatic GC process.

### Key Files and Locations

Based on the PRD background context:

- Terminal configurations that are getting deleted are primarily in:
  - `~/.config/zsh/` - Zsh configuration files
  - `~/.cache/` - Cache files including terminal state
  - XDG standard directories - Following XDG Base Directory specification
- GC roots that need investigation:
  - `/nix/var/nix/gcroots/` - Main GC roots directory
  - `/nix/var/nix/gcroots/per-user/$USER/` - Per-user roots (may not exist - this is the suspected issue)
  - `/nix/var/nix/gcroots/auto/` - Auto-generated roots that may contain stale entries

### Technical Constraints

- Work within macOS SIP constraints (System Integrity Protection enabled)
- The system uses nix-darwin with Home Manager
- Weekly automatic GC is triggered by launchd every Sunday at 00:00
- Both `useUserPackages = true` and XDG-based configurations need to be considered

### Testing Standards

Since this is a bug reproduction story, formal testing is not required. However:

- All captured data should be verifiable and reproducible
- Use standard Unix tools (ls, find, shasum) for consistency
- Document any permission issues encountered during capture
- Ensure temp directory structure is clear and well-organized for comparison

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References

- Confirmed missing per-user GC root directory: `/nix/var/nix/gcroots/per-user/happygopher/` does not exist
- Discovered critical issue: Despite `useUserPackages = true`, `/nix/var/nix/profiles/per-user/happygopher/` does not exist
- Found Home Manager integrated as nix-darwin module (per flake.nix line 115)
- Verified profiles remain in XDG location: `~/.local/state/nix/profiles/home-manager`
- Confirmed technical analysis finding about `useUserPackages` behavior

### Completion Notes List

- Successfully captured 95 configuration files with SHA256 checksums
- Documented critical GC root finding: Both `/nix/var/nix/gcroots/per-user/$USER/` and `/nix/var/nix/profiles/per-user/$USER/` are missing
- Captured Home Manager generations (100-105) and Darwin system generations (136-155) using direct profile paths
- Created comprehensive documentation confirming root cause from technical analysis
- Verified `useUserPackages = true` is set but profile symlinks remain in XDG location

### File List

- Created: `temp/before-gc/` directory structure
- Created: `temp/before-gc/config/zsh/` (copied from ~/.config/zsh/)
- Created: `temp/before-gc/cache/` (p10k, fsh, and zsh cache files)
- Created: `temp/before-gc/xdg/` (zsh state)
- Created: `temp/before-gc/checksums.txt` (95 file checksums)
- Created: `temp/before-gc/gc-roots.txt` (comprehensive GC root analysis)
- Created: `temp/before-gc/generations.txt` (all profile generations)
- Created: `temp/before-gc/README.md` (documentation with root cause confirmation)

## QA Results

### Review Date: 2025-08-17

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

This is a bug reproduction story focused on capturing system state, not a code implementation story. The developer executed a comprehensive state capture operation with excellent attention to detail and thorough documentation. The implementation demonstrates senior-level understanding of the Nix ecosystem and the specific bug being investigated.

### Refactoring Performed

N/A - This story involves system state capture and analysis, not code implementation. No refactoring is applicable.

### Compliance Check

- Coding Standards: ✓ N/A (no code written)
- Project Structure: ✓ temp/ directory used as specified
- Testing Strategy: ✓ N/A (bug reproduction story as noted in Dev Notes)
- All ACs Met: ✓ All 5 acceptance criteria fully satisfied

### Improvements Checklist

No improvements needed. The developer exceeded expectations by:

- [x] Discovering and documenting the critical missing per-user GC root directory
- [x] Confirming the root cause analysis from the technical document
- [x] Capturing comprehensive state with 95 files and checksums
- [x] Creating excellent documentation with clear findings
- [x] Working around the home-manager integration to capture all generations

### Security Review

No security concerns. All captured data is configuration state only, no secrets or sensitive information included.

### Performance Considerations

N/A - State capture operation with no performance impact.

### Technical Excellence Notes

The developer demonstrated exceptional debugging skills:

1. Identified that `/nix/var/nix/gcroots/per-user/happygopher/` does not exist - confirming the suspected root cause
2. Discovered that despite `useUserPackages = true`, the profiles remain in XDG locations
3. Found home-manager is integrated as a nix-darwin module, not standalone
4. Captured generations using the correct profile paths after initial command failures
5. Created comprehensive documentation that will be invaluable for the next phase

### Final Status

✓ Approved - Ready for Done

Outstanding work on this bug reproduction story. The captured state and findings provide solid evidence for the root cause and will enable effective solution development in subsequent stories.
