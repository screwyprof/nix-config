# Story 1.1: Capture Current Working State

## Status

Approved

## Story

**As a** developer,
**I want** to capture the current working terminal configuration state,
**so that** I can compare before and after GC states.

## Acceptance Criteria

1. Capture all relevant configuration files from ~/.config/zsh, ~/.cache, and XDG directories
2. Document current GC root structure in /nix/var/nix/gcroots/
3. Record current generation numbers for both system and user profiles
4. Store captured state in ./temp/ directory for comparison
5. Create checksums of critical configuration files

## Tasks / Subtasks

- [ ] Task 1: Capture terminal configuration files (AC: 1, 5)
  - [ ] Create temp directory structure for storing captured state
  - [ ] Copy all files from ~/.config/zsh/ to temp/before-gc/config/zsh/
  - [ ] Copy relevant cache files from ~/.cache/ (particularly zsh and terminal-related)
  - [ ] Copy XDG configuration files from standard XDG paths
  - [ ] Generate SHA256 checksums for all captured files and store in temp/before-gc/checksums.txt
- [ ] Task 2: Document GC root structure (AC: 2)
  - [ ] List all contents of /nix/var/nix/gcroots/ directory
  - [ ] Check if /nix/var/nix/gcroots/per-user/$USER/ exists
  - [ ] Document all symlinks in /nix/var/nix/gcroots/auto/
  - [ ] Save complete GC root listing to temp/before-gc/gc-roots.txt
- [ ] Task 3: Record generation information (AC: 3)
  - [ ] Run `nix-env --list-generations` for default profile
  - [ ] Run `home-manager generations` to list HM generations
  - [ ] Run `darwin-rebuild --list-generations` for system generations
  - [ ] Store all generation info in temp/before-gc/generations.txt
- [ ] Task 4: Create comprehensive state documentation (AC: 4)
  - [ ] Create README.md in temp/before-gc/ explaining the captured structure
  - [ ] Include timestamp of capture
  - [ ] Document the system configuration being tested (nix-darwin version, HM version)
  - [ ] Note any relevant environment variables or special configurations

## Dev Notes

### Previous Story Insights

No previous story exists - this is the first story in the project.

### Technical Analysis Reference

For comprehensive technical analysis and root cause findings, see: [`docs/ideas/nix-gc-removes-current-settings/06-summary.md`](../../ideas/nix-gc-removes-current-settings/06-summary.md)

### Testing Context

This is a bug reproduction story. The goal is to systematically capture the working state before garbage collection so we can identify exactly what gets deleted during the automatic GC process.

### Key Files and Locations

Based on the PRD background context:

- Terminal configurations that are getting deleted are primarily in:
  - `~/.config/zsh/` - Zsh configuration files
  - `~/.cache/` - Cache files including terminal state
  - XDG standard directories - Following XDG Base Directory specification
- GC roots that need investigation:
  - `/nix/var/nix/gcroots/` - Main GC roots directory
  - `/nix/var/nix/gcroots/per-user/$USER/` - Per-user roots (may not exist - this is the suspected issue)
  - `/nix/var/nix/gcroots/auto/` - Auto-generated roots that may contain stale entries

### Technical Constraints

- Work within macOS SIP constraints (System Integrity Protection enabled)
- The system uses nix-darwin with Home Manager
- Weekly automatic GC is triggered by launchd every Sunday at 00:00
- Both `useUserPackages = true` and XDG-based configurations need to be considered

### Testing Standards

Since this is a bug reproduction story, formal testing is not required. However:

- All captured data should be verifiable and reproducible
- Use standard Unix tools (ls, find, shasum) for consistency
- Document any permission issues encountered during capture
- Ensure temp directory structure is clear and well-organized for comparison

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
