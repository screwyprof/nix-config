# Story 1.2: Manual GC Test - Complete Self-Contained Report

## Executive Summary

**Manual garbage collection did NOT break user settings.** The chmod permission errors prevented actual deletion of store paths, explaining why manual GC behaves differently than automatic GC. This report contains all evidence and findings in a self-contained format.

## Test Context

**Date**: 2025-08-17  
**Time**: ~06:10 (after automatic GC should have run at 00:00)  
**Test Type**: Manual garbage collection with sudo

## Key Mystery

The automatic GC was scheduled to run at Sunday 00:00, yet when the baseline was captured around 06:00, the system was still working normally. This suggested the automatic GC either:

1. Failed to run
2. Ran but failed with errors
3. Has different behavior than manual GC

## Manual GC Test Execution

### Commands Executed

```bash
# Using the nix-cleanup alias
alias | grep nix-cleanup
# Output: nix-cleanup='sudo -H nix-collect-garbage --delete-older-than 7d && sudo -H nix store optimise'

# Direct execution
sudo nix-collect-garbage --delete-older-than 30d --max-freed 8G
```

### Captured Output

```bash
warning: $HOME ('/Users/happygopher') is not owned by you, falling back to the one defined in the 'passwd' file ('/var/root')
removing old generations of profile /nix/var/nix/profiles/per-user/root/profile
removing old generations of profile /nix/var/nix/profiles/per-user/root/channels
removing old generations of profile /nix/var/nix/profiles/system
finding garbage collector roots...
deleting garbage...
deleting '/nix/store/n2nyif07ah4g6zsy3zamnp3pjv7m8gd6-iterm2-3.5.10'
error: chmod "/nix/store/n2nyif07ah4g6zsy3zamnp3pjv7m8gd6-iterm2-3.5.10/Applications/iTerm2.app": Operation not permitted
1 store paths deleted, 0.00 MiB freed
```

### Store Optimization

```bash
sudo nix-store --optimise
# Output: 2.30 MiB freed by hard-linking 434 files
```

## Critical Findings

### 1. Permission Error Details

- **Error**: `chmod "/nix/store/.../iTerm2.app": Operation not permitted`
- **macOS Popup**: "Cursor is prevented from changing apps"
- **Result**: Only 1 store path attempted deletion, 0.00 MiB actually freed
- **Impact**: chmod errors protected the system from actual deletion

### 2. Profiles Processed

Manual GC only attempted to clean:

- `/nix/var/nix/profiles/per-user/root/profile`
- `/nix/var/nix/profiles/per-user/root/channels`  
- `/nix/var/nix/profiles/system`

**NOT processed**:

- User profiles (because `/nix/var/nix/profiles/per-user/happygopher/` doesn't exist)
- Home Manager profiles in XDG location

### 3. Terminal State After GC

```bash
# Check for P10k wizard
# Result: NO WIZARD APPEARED - terminal launched normally

# Verify zsh configurations
ls -la ~/.config/zsh/
# All symlinks intact:
# .zimrc -> /nix/store/.../home-manager-files/.config/zsh/.zimrc
# .zshenv -> /nix/store/.../home-manager-files/.config/zsh/.zshenv
# .zshrc -> /nix/store/.../home-manager-files/.config/zsh/.zshrc
```

### 4. GC Root Analysis

**Before GC**: 106 entries in `/nix/var/nix/gcroots/auto/`  
**After GC**: 87 entries (19 stale roots cleaned)

**Critical Root Still Protected**:

```bash
ls -la /nix/var/nix/gcroots/auto/ | grep current
# Output: 4vznz0n2bvc59pmzdqwgrd0627nbc9mf -> /Users/happygopher/.local/state/home-manager/gcroots/current-home

# Verify chain
ls -la ~/.local/state/home-manager/gcroots/current-home
# Points to: /nix/store/1aapq7qp2zk41jhiz0267hyznjja6zgp-home-manager-generation
```

The current-home GC root successfully protected the user profile during manual GC.

### 5. Checksum Verification

File integrity checks showed:

- All configuration files remain intact
- Minor changes in cache files (normal operation)
- No configuration files were deleted or modified
- All symlinks remain valid

## Automatic GC Configuration

Retrieved from `/Library/LaunchDaemons/org.nixos.nix-gc.plist`:

```xml
<key>ProgramArguments</key>
<array>
    <string>/bin/sh</string>
    <string>-c</string>
    <string>/bin/wait4path /nix/store &amp;&amp; exec /nix/store/.../bin/nix-collect-garbage --delete-older-than 30d --max-freed 8G</string>
</array>
<key>StartCalendarInterval</key>
<dict>
    <key>Hour</key><integer>0</integer>
    <key>Minute</key><integer>0</integer>
    <key>Weekday</key><integer>0</integer>
</dict>
```

**Key differences**:

- Uses `/bin/wait4path` (may need Full Disk Access)
- Runs in system context via launchd
- Service status showed last exit code: 1 (failure)

## Permission Context Analysis

### Manual sudo Execution

- Terminal app shows permission popup
- chmod operations blocked by macOS security
- Runs with user's sudo privileges
- Result: Protection by permission errors

### Launchd Execution (Hypothesis)

- No terminal app involved
- Uses `/bin/wait4path` with potentially different permissions
- Runs as true system service
- May bypass certain permission restrictions

## Critical Observations

1. **Sunday Mystery**: Automatic GC should have run at 00:00 but system was working at 06:10
2. **GC Failed**: chmod errors prevented GC from doing its job (which coincidentally saved the terminal this time)
3. **GC Root Present**: The current-home root existed but we can't verify if it protected anything since GC failed on chmod errors
4. **Different Contexts**: Manual vs automatic GC have fundamentally different permission contexts

## Conclusions

1. **Manual GC failed to delete anything** - chmod errors on .app bundles prevented any store path deletion
2. **Automatic GC remains untested** - Different permission context via launchd may bypass chmod errors
3. **No intended protection mechanism exists** - The chmod errors are an unintended side effect, not a designed safeguard
4. **Next test needed** - Must test actual launchd execution to reproduce bug

## Recommendations for Next Story

1. Test launchd-triggered GC specifically
2. Investigate Full Disk Access requirements
3. Monitor permission differences between contexts
4. Check if launchd GC can bypass chmod restrictions

---

This report is self-contained and includes all evidence from Story 1.2 testing. Manual GC proved safe due to permission errors, but the automatic GC remains the suspected cause of user configuration loss.
