# Story 1.3: Launchd GC Investigation - Complete Self-Contained Report

## Executive Summary

**BUG SUCCESSFULLY REPRODUCED!** The P10k configuration wizard appeared after executing a specific two-stage garbage collection sequence. This report contains all evidence, commands, and findings in a self-contained format that will remain valid even if temporary files are removed.

## Investigation Timeline

### Phase 1: Initial Launchd Service Analysis

**Objective**: Understand how the weekly GC service works and why it might delete user configurations.

**Service Configuration** (captured from `/Library/LaunchDaemons/org.nixos.nix-gc.plist`):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>org.nixos.nix-gc</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>/bin/wait4path /nix/store &amp;&amp; exec /nix/store/nb3yjnqy9fqkq7viwlviarp68qx0wlzi-nix-2.28.4/bin/nix-collect-garbage --delete-older-than 30d --max-freed 8G</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>0</integer>
        <key>Minute</key>
        <integer>0</integer>
        <key>Weekday</key>
        <integer>0</integer>
    </dict>
</dict>
</plist>
```

**Key findings from service analysis**:

- Runs weekly on Sunday at 00:00
- Executes as root in system domain
- Uses `/bin/wait4path` to ensure /nix/store exists
- Deletes generations older than 30 days with 8GB max

### Phase 2: Failed Reproduction Attempts

**Command executed**:

```bash
sudo launchctl kickstart -k system/org.nixos.nix-gc
```

**Service status check**:

```bash
sudo launchctl list | grep nix-gc
# Output: - 1 org.nixos.nix-gc
```

Exit code 1 indicates failure. To understand why, I ran the exact launchd command manually:

```bash
sudo /bin/sh -c '/bin/wait4path /nix/store && exec /nix/store/nb3yjnqy9fqkq7viwlviarp68qx0wlzi-nix-2.28.4/bin/nix-collect-garbage --delete-older-than 30d --max-freed 8G' 2>&1
```

**Output captured**:

```bash
warning: $HOME ('/Users/happygopher') is not owned by you, falling back to the one defined in the 'passwd' file ('/var/root')
removing old generations of profile /nix/var/nix/profiles/per-user/root/profile
removing old generations of profile /nix/var/nix/profiles/per-user/root/channels
removing old generations of profile /nix/var/nix/profiles/system
finding garbage collector roots...
deleting garbage...
deleting '/nix/store/n2nyif07ah4g6zsy3zamnp3pjv7m8gd6-iterm2-3.5.10'
error: chmod "/nix/store/n2nyif07ah4g6zsy3zamnp3pjv7m8gd6-iterm2-3.5.10/Applications/iTerm2.app": Operation not permitted
1 store paths deleted, 0.00 MiB freed
```

**Critical observations**:

1. Only attempts to clean root profiles, not user profiles
2. Fails with chmod error on .app bundles
3. This error prevents successful completion

### Phase 3: GC Root Investigation

**Question**: Why did we expect GC roots in `/nix/var/nix/gcroots/per-user/happygopher/` but found them elsewhere?

**Commands and findings**:

```bash
# Check for traditional per-user directory
ls -la /nix/var/nix/gcroots/per-user/
# Output:
# total 0
# drwxr-xr-x 2 root nixbld  64 Dec 11  2024 .
# drwxr-xr-x 5 root nixbld 160 Aug 10 05:27 ..
```

No user subdirectory exists! This was unexpected based on traditional Nix patterns.

```bash
# Search for Home Manager GC roots
ls -la /nix/var/nix/gcroots/auto/ | grep -i current | grep home
# Output:
# lrwxr-xr-x 1 root nixbld 65 Aug 10 05:27 4vznz0n2bvc59pmzdqwgrd0627nbc9mf -> /Users/happygopher/.local/state/home-manager/gcroots/current-home
```

**Discovery**: Home Manager uses XDG Base Directory specification!

```bash
# Verify the indirect root chain
ls -la ~/.local/state/home-manager/gcroots/current-home
# Output:
# lrwxr-xr-x 1 happygopher staff 67 Aug 10 05:27 /Users/happygopher/.local/state/home-manager/gcroots/current-home -> /nix/store/1aapq7qp2zk41jhiz0267hyznjja6zgp-home-manager-generation
```

This creates an indirect GC root that Nix automatically registers in `/nix/var/nix/gcroots/auto/`.

**Important Note about `sudo -H`**: The `-H` flag sets HOME to the target user's home directory. When running `sudo -H` as root, HOME becomes `/var/root`, not the current user's home. This explains why the GC runs in root's context and targets root profiles.

### Phase 4: Successful Bug Reproduction

**Environment**: iTerm2 with Full Disk Access enabled (System Settings → Privacy & Security → Full Disk Access)

#### Step 1: User-level GC

```bash
# Check alias definition
alias | grep nix-cleanup
# Output: nix-cleanup='sudo -H nix-collect-garbage --delete-older-than 7d && sudo -H nix store optimise'

# Execute user GC
nix-cleanup
# Output:
# 9386 store paths deleted, 10212.69 MiB freed
# currently hard linking saves 9017.75 MiB
```

#### Step 2: System-level GC via launchd

```bash
sudo launchctl kickstart -k system/org.nixos.nix-gc

# Check exit status
sudo launchctl list | grep nix-gc
# Output: - 0 org.nixos.nix-gc
```

Exit code 0 - SUCCESS! This is different from previous attempts.

#### Step 3: Open new terminal

Result: P10k configuration wizard appeared with message:

```text
This is Powerlevel10k configuration wizard. You are seeing it because you haven't
defined any Powerlevel10k configuration options. It will ask you a few questions and
configure your prompt.
```

### Phase 5: Root Cause Analysis

**What broke?**

The critical store path was deleted: `/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/`

**Evidence this path existed before** (from Story 1.1 baseline captures):

1. In P10k instant prompt cache:

   ```bash
   grep -n "mfkixld2qzjijisc847ppymyx53irisx" temp/before-gc/cache/p10k-instant-prompt-happygopher.zsh
   # Line 15: References this store path
   ```

1. In P10k dump file:

   ```bash
   grep -n "_POWERLEVEL9K_CONFIG_FILE" temp/before-gc/cache/p10k-dump-happygopher.zsh
   # Line 165: typeset -g _POWERLEVEL9K_CONFIG_FILE=/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/home/modules/shared/cli/themes/programs/zsh/p10k.zsh
   ```

1. In ZIM initialization:

   ```bash
   grep -n "mfkixld2qzjijisc847ppymyx53irisx" temp/before-gc/config/zsh/zsh/.zim/init.zsh
   # Line 21: source "/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/home/modules/shared/cli/themes/programs/zsh/p10k.zsh"
   ```

**Post-GC verification**:

```bash
# Check if symlinks still exist
ls -la ~/.config/zsh/.zimrc
# Output: lrwxr-xr-x 1 happygopher staff 81 Aug 10 05:26 .zimrc -> /nix/store/247mlinj56l62pl5y9vacdyirmibb8qa-home-manager-files/.config/zsh/.zimrc

# But the referenced store path is gone
ls -la /nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/
# Output: ls: cannot access '/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/': No such file or directory
```

**Generation analysis**:

```bash
# Count remaining generations
ls -la /nix/var/nix/profiles/system-* | wc -l
# Output: 1

ls -la ~/.local/state/nix/profiles/home-manager-*-link | wc -l
# Output: 6
```

Only 1 system generation remains (current), but 6 Home Manager generations (100-105) survived. The problem: Home Manager's indirect GC root protects the generation link but not all transitive dependencies.

## Technical Explanation

### Why Home Manager Uses XDG Paths

Home Manager follows the XDG Base Directory specification rather than traditional Nix patterns:

- **Traditional (expected)**: `/nix/var/nix/gcroots/per-user/$USER/`
- **Actual (XDG-compliant)**: `~/.local/state/home-manager/gcroots/current-home`

This is by design and is normal for Home Manager when used with nix-darwin.

### The Two-Stage GC Pattern

The bug reproduction required:

1. **`nix-cleanup` (runs as root with sudo -H)** - Freed 10GB by cleaning system/root profiles and unreferenced store paths
2. **Launchd GC (also runs as root)** - Succeeded with exit code 0 after chmod errors were somehow bypassed
3. **Result** - The store path `/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/` was deleted despite Home Manager roots

### Permission Context

What we observed:

- Initial launchd attempts failed with chmod errors on iTerm2.app bundle (exit code 1)
- After running `nix-cleanup` and with iTerm2 having FDA, launchd GC succeeded (exit code 0)
- The role of FDA is unclear - correlation but not proven causation

## Open Questions

1. **Full Disk Access Impact**
   - Launchd runs as root in system domain - why does it need FDA?
   - Was the success due to FDA or just because `nix-cleanup` freed up the problematic store paths or both?

2. **Launchd Service Configuration**
   - Can `nix-darwin` configure launchd service permissions?
   - Is there a way to grant FDA programmatically?
   - Should automatic GC be disabled until resolved?

3. **Research Commands Needed**

   ```bash
   # Check launchd environment
   sudo launchctl procinfo <pid> | grep -A20 "posix creds"
   
   # FDA status for binaries
   codesign -dvvv /bin/sh
   codesign -dvvv /nix/store/*/bin/nix-collect-garbage
   ```

## Conclusions

1. **The bug was reproduced** - But only under specific conditions
2. **Required conditions**:
   - iTerm2 with Full Disk Access enabled
   - Manual `nix-cleanup` run (which cleans root/system profiles with `sudo -H`)
   - Manual trigger of launchd GC (which also runs as root)
3. **Both GCs run as root** - Neither directly touches Home Manager profiles in `~/.local/state/`
4. **The mystery**: Both GCs run as root and clean system/root profiles, yet user's P10k config was deleted. The 10GB freed must have included store paths that Home Manager depended on

## Key Technical Facts Established

1. **`sudo -H` behavior**: Sets HOME to root's directory (`/var/root`), explaining why GC targets root profiles
2. **GC scope**: Both manual (`sudo -H`) and launchd GC run as root and only clean system/root profiles - they do NOT directly clean user profiles
3. **Home Manager GC roots**: Uses XDG paths (`~/.local/state/home-manager/gcroots/`), not traditional `/nix/var/nix/gcroots/per-user/$USER/`

## Recommendations

1. **Immediate**: Create proper GC roots for all Home Manager dependencies
2. **Short-term**: Document the two-stage GC risk and FDA implications
3. **Long-term**: Consider `useUserPackages = true` to use system profile paths
4. **Investigation**: Understand FDA's role in launchd service permissions

## Appendix: All Key Commands for Reproduction

```bash
# Prerequisites
# 1. Grant iTerm2 Full Disk Access in System Settings

# Reproduction sequence
# Step 1: User GC
sudo -H nix-collect-garbage --delete-older-than 7d && sudo -H nix store optimise

# Step 2: System GC
sudo launchctl kickstart -k system/org.nixos.nix-gc

# Step 3: Verify
open -n -a iTerm  # P10k wizard should appear

# Diagnostic commands
sudo launchctl list | grep nix-gc
ls -la /nix/var/nix/gcroots/per-user/
ls -la ~/.local/state/home-manager/gcroots/
grep -r "mfkixld2qzjijisc847ppymyx53irisx" ~/.config/
```

---

This report is self-contained and will remain valid even after temporary files are removed. All evidence, commands, and outputs are captured inline.
