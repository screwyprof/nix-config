# Story 1.2: Test Manual GC as Root

## Status

Approved

## Story

**As a** developer,
**I want** to test garbage collection when run manually as root,
**so that** I can verify if the issue is specific to launchd execution.

## Acceptance Criteria

1. Execute GC using sudo with the same parameters as the weekly job
2. Verify if terminal configurations remain intact after GC
3. Document any differences in GC root handling between manual and automatic runs
4. Check if P10k wizard is triggered after manual GC
5. Compare post-GC state with captured baseline

## Tasks / Subtasks

- [ ] Task 1: Prepare for manual GC test (AC: 1)
  - [ ] Verify current system state matches captured baseline from Story 1.1
  - [ ] Document the exact GC command used by the weekly job (check nix-darwin configuration)
  - [ ] Ensure terminal is in a fresh state (restart terminal session)
  - [ ] Note current disk usage with `nix-store-size` command
- [ ] Task 2: Execute manual garbage collection (AC: 1, 3)
  - [ ] Run GC command with sudo: `sudo nix-collect-garbage --delete-older-than 7d`
  - [ ] Also run store optimization: `sudo nix-store --optimise`
  - [ ] Capture all output and any errors to temp/manual-gc/gc-output.log
  - [ ] Note execution time and any permission-related messages
- [ ] Task 3: Verify terminal configuration state (AC: 2, 4)
  - [ ] Open a new terminal session
  - [ ] Check if P10k configuration wizard appears
  - [ ] Verify zsh configuration files still exist in ~/.config/zsh/
  - [ ] Test that all terminal customizations are still active
  - [ ] Document findings in temp/manual-gc/terminal-state.txt
- [ ] Task 4: Analyze GC root changes (AC: 3, 5)
  - [ ] List current GC roots in /nix/var/nix/gcroots/
  - [ ] Compare with baseline captured in Story 1.1
  - [ ] Check if /nix/var/nix/gcroots/per-user/$USER/ was created
  - [ ] Document any changes to auto-generated roots
  - [ ] Create diff report: temp/manual-gc/gc-roots-diff.txt
- [ ] Task 5: Create comparison report (AC: 5)
  - [ ] Generate checksums of configuration files post-GC
  - [ ] Compare with baseline checksums from Story 1.1
  - [ ] Document which files (if any) were removed or modified
  - [ ] Create summary report: temp/manual-gc/comparison-report.md

## Example Output Formats

### Expected GC Command Output

```bash
$ sudo nix-collect-garbage --delete-older-than 7d
removing old generations of profile /nix/var/nix/profiles/per-user/happygopher/profile
removing generation 42
removing generation 43
...
finding garbage collector roots...
deleting garbage...
deleting '/nix/store/abc123...-home-manager-path'
deleting '/nix/store/def456...-zsh-config'
...
1234 store paths deleted, 567.89 MiB freed

$ sudo nix-store --optimise
optimising path '/nix/store/...'
1234.56 MiB saved by hard-linking 123 files
```

### Example GC Roots Listing

```bash
$ ls -la /nix/var/nix/gcroots/
total 0
drwxr-xr-x  4 root  wheel  128 Aug 12 10:00 .
drwxr-xr-x  8 root  wheel  256 Aug 12 10:00 ..
drwxr-xr-x 15 root  wheel  480 Aug 12 10:00 auto
drwxr-xr-x  3 root  wheel   96 Aug 12 10:00 per-user

$ ls -la /nix/var/nix/gcroots/per-user/
total 0
drwxr-xr-x  3 root  wheel   96 Aug 12 10:00 .
drwxr-xr-x  4 root  wheel  128 Aug 12 10:00 ..
drwxr-xr-x  2 happygopher  staff   64 Aug 12 10:00 happygopher  # This may be missing!
```

### Sample Generation Listing

```bash
$ nix-env --list-generations
   1   2024-12-01 12:00:00
   2   2024-12-15 14:30:00
   3   2025-01-05 09:15:00   (current)

# For Home Manager generations (managed by nix-darwin)
$ ls -la /nix/var/nix/profiles/per-user/$USER/home-manager*
home-manager -> home-manager-3-link
home-manager-1-link -> /nix/store/...-home-manager-generation
home-manager-2-link -> /nix/store/...-home-manager-generation
home-manager-3-link -> /nix/store/...-home-manager-generation

# Alternative: Use nix shell if home-manager CLI needed
$ nix shell nixpkgs#home-manager -c home-manager generations
```

## Dev Notes

### Important Testing Isolation Note

Consider using Nix development shells or temporary shells for testing to avoid polluting the real system:

```bash
# Create isolated shell for testing
nix shell nixpkgs#coreutils nixpkgs#findutils -c bash
```

### Previous Story Insights

Story 1.1 established the baseline state capture. The temp/before-gc/ directory contains:

- Complete terminal configuration files
- GC root structure documentation
- Generation information for all profiles
- SHA256 checksums of all critical files

### Technical Analysis Reference

For comprehensive technical analysis and root cause findings, see: [`docs/ideas/nix-gc-removes-current-settings/06-summary.md`](../../ideas/nix-gc-removes-current-settings/06-summary.md)

### Testing Context

This story tests the manual execution path of garbage collection to determine if the bug is specific to launchd's execution context. The hypothesis from the PRD is that manual GC (with proper sudo permissions) may handle GC roots differently than launchd-triggered GC.

### Key Commands and Parameters

Based on the PRD and common nix-darwin configurations:

- The weekly GC typically runs: `nix-collect-garbage --delete-older-than 7d`
- Store optimization often follows: `nix-store --optimise`
- The `nix-cleanup` alias mentioned in the PRD should be tested if available
- Generation limits are set to â‰¤3 for both system and HM profiles

**IMPORTANT**: When running with `sudo`, GC operates at system-level:

- Cleans system profile: `/nix/var/nix/profiles/system`
- May also attempt to clean user profiles: `/nix/var/nix/profiles/per-user/*`
- Permission context affects what can be accessed

### Expected Behaviors

According to the root cause analysis in the PRD:

- Manual GC with sudo might preserve configurations (need to verify)
- P10k wizard should NOT appear if configurations are preserved
- GC roots in per-user directory might be handled differently with sudo
- Permission context differences between sudo and launchd are critical

### Technical Constraints

- Must use sudo for GC commands (root permissions required)
- SIP (System Integrity Protection) remains enabled
- Cannot modify system-level launchd configurations
- Must work within standard macOS permission model

### Testing Standards

- All commands must be run exactly as documented
- Output must be captured verbatim for analysis
- Timestamps should be included in all log files
- Use consistent file naming in temp/ directory structure
- Document any unexpected behaviors or errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
