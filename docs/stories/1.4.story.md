# Story 1.4: Create Bug Reproduction Report

## Status

InProgress

## Story

**As a** developer,
**I want** to document the reproduction findings,
**so that** we have a clear baseline for validating the fix.

## Acceptance Criteria

1. Investigate and understand WHY the bug happens (address QA's confusion points)
2. Document findings about permission contexts, FDA role, and GC mechanisms
3. Be explicit about what remains unknown despite investigation
4. Create postmortem only after root causes are understood
5. Provide clear recommendations for Epic 2 based on investigation

## Tasks / Subtasks

- [ ] Task 1: Create investigation report (AC: 1, 2) **INCOMPLETE**
  - [x] Create docs/stories/1.4-investigation-report.md
  - [x] Document investigation methodology and test environment
  - [ ] Include all commands, outputs, and findings **GAPS IDENTIFIED**
  - [ ] Keep investigation self-contained (no temp file references)
- [ ] Task 2: Investigate why sudo can chmod but launchd can't (AC: 2, 3) **NEEDS EVIDENCE**
  - [x] Test chmod operations in different FDA contexts (Terminal vs iTerm2)
  - [x] Compare with/without FDA on same commands
  - [x] Document exact error messages and exit codes
  - [ ] Include full command outputs in investigation report
- [ ] Task 3: Investigate Full Disk Access role (AC: 2, 3) **SURFACE LEVEL ONLY**
  - [x] Check mount flags for /nix filesystem
  - [x] Test if FDA bypasses "protect" mount flag
  - [ ] Research Apple documentation on FDA behavior
  - [ ] Document what FDA actually does vs assumptions
- [ ] Task 4: Understand how root-level GC deletes user configs (AC: 2, 3) **PARTIAL**
  - [x] Trace GC roots for user profiles vs embedded paths
  - [x] Search comprehensively for store references in XDG dirs
  - [x] Quantify findings (e.g., "49 symlinks, 3 config files")
  - [ ] Document why some paths are protected and others aren't
- [x] Task 5: Analyze the two-stage GC pattern requirement (AC: 2, 3) **COMPLETE**
  - [x] Document what manual GC removes that launchd cannot
  - [x] Show launchd service configuration and exit codes
  - [x] Explain why manual intervention unblocks automated GC
  - [x] Include evidence from Story 1.3 reproduction
- [ ] Task 6: Create comprehensive postmortem (AC: 1, 4, 5) **PREMATURE - REDO AFTER INVESTIGATION**
  - [x] Create docs/postmortems/nix-gc-removes-current-settings.md **INVALID - CREATED TOO EARLY**
  - [ ] Base on findings from 1.4-investigation-report.md **FINDINGS INCOMPLETE**
  - [ ] Address QA's specific confusion points clearly
  - [ ] Provide actionable recommendations for Epic 2
  - [ ] Document remaining unknowns honestly

## Postmortem Requirements

The postmortem (created AFTER investigation completes) must:

1. **Problem**: Clear statement of what went wrong
2. **Evidence**: Facts from investigation with sources
3. **Root Cause**: Why it happens (based on evidence)
4. **Recommendations**: Approaches for Epic 2 (not prescriptive)

## Dev Notes

### Resources

- **Reproduction Evidence**: `docs/stories/1.3-investigation-report.md`
- **Prior In Depth Analysis**: `docs/ideas/nix-gc-removes-current-settings/06-summary.md` (large file - search for specific topics, don't read whole)

### Investigation Gaps Requiring Completion

Complete these before creating postmortem:

1. **FDA Mechanism - WHAT it actually does**
   - We know FDA allows chmod on protected paths, but HOW does it work?
   - Is this behavior documented anywhere by Apple?
   - Does FDA work the same way on all filesystems or just specific ones?

2. **"protect" Mount Flag - WHAT this means**
   - What exactly does the "protect" flag do?
   - How is it different from read-only?
   - Is this a standard macOS feature or Nix-specific?

3. **Home Manager Design - WHY hardcoded paths**
   - Why does HM generate configs with embedded store paths instead of using indirection?
   - Is this a known issue in the HM community?
   - Are there existing solutions or workarounds?

4. **GC Root Protection - HOW it actually works**
   - We found some paths have roots and others don't - but WHY?
   - What's the exact algorithm Nix uses to determine what needs roots?
   - Why aren't transitive dependencies automatically protected?

5. **launchd + FDA - CAN it be done**
   - Is there ANY way to grant FDA to launchd services?
   - Have others solved this problem?
   - What are the security implications if it were possible?

### Investigation Standards

- Document commands with full outputs
- Note execution context (user/sudo/FDA status)
- Missing tools: Use `nix shell nixpkgs#<tool>`
- If terminal broken: `nix-rebuild-host`

_Postmortem format: Follow `docs/ideas/document-refinement-principles.md` - Problem, Evidence, Root Cause, Unknowns, Recommendations_

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (SM) |
| 2025-08-17 | 2.0 | Complete rewrite to focus on QA's specific questions and postmortem creation | Bob (SM) |
| 2025-08-18 | 3.0 | Course correction: Investigation incomplete, return to fill gaps | Bob (SM) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

- ✓ Verified FDA allows chmod on protected `/nix/store` paths
- ✓ Confirmed launchd and sudo behave identically without FDA
- ✓ Traced how user configs get deleted through missing transitive GC roots
- ✓ Explained two-stage GC pattern (manual removes obstacles, launchd completes)
- ✓ Created postmortem addressing all QA confusion points

### File List

- Created: `docs/postmortems/nix-gc-removes-current-settings.md`
- Created: `docs/stories/1.4-investigation-report.md`
- Created: `temp/story-1.4/no-fda-store-chmod.txt`
- Modified: `docs/stories/1.4.story.md`

## QA Results

_To be populated by QA Agent_
