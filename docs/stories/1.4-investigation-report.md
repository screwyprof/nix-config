# Story 1.4: Investigation Report - Addressing QA's Questions

## ⚠️ Investigation Status: INCOMPLETE

This investigation was concluded prematurely. The following critical areas need completion before creating the postmortem:

1. **No deep FDA mechanism investigation** - Only surface-level testing done
2. **"protect" mount flag unexplored** - What does it actually do?
3. **Home Manager source uninvestigated** - Why hardcoded paths?
4. **GC root mechanism not fully traced** - How exactly are roots resolved?
5. **launchd FDA possibilities untested** - Assumed "no" without comprehensive testing

See updated story document for specific investigation tasks needed.

---

## Executive Summary

This report documents the investigation into QA's specific questions about the Nix GC bug. While Story 1.3 successfully reproduced the bug, QA was confused about WHY it happened. Through systematic investigation, we discovered:

1. **FDA enables chmod on protected filesystems** - Not documented by Apple
2. **User configs deleted through missing transitive GC roots** - Embedded store paths aren't protected
3. **Two-stage pattern required due to chmod obstacles** - Manual GC with FDA clears the way

## Investigation Methodology

### Test Environment

- macOS with `/nix` mounted with "protect" flag
- Terminal.app (no FDA) vs iTerm2 (with FDA)
- VSCode app from Nix store as test subject

### Key Commands Used

```bash
# Check mount flags
mount | grep "/nix"

# Test chmod behavior
sudo chmod 755 "/nix/store/.../Visual Studio Code.app"

# Find store references
find ~/.config ~/.local ~/.cache -type l -exec ls -la {} \; | grep "/nix/store"
find ~/.config -type f ! -type l -exec grep -l "/nix/store" {} \;

# Check GC roots
nix-store -q --roots <store-path>
```

## Question 1: Why can sudo chmod but launchd can't?

### Investigation

Tested chmod operations in different environments:

```bash
# 1. Copy app to writable location - works everywhere
cp -R "/nix/store/87qzdgr0fl4166yjhx11xhc64ncvzqxd-vscode-1.102.3/Applications/Visual Studio Code.app" temp/story-1.4/
sudo chmod 755 "temp/story-1.4/Visual Studio Code.app"  # Success

# 2. Terminal WITHOUT FDA - fails on /nix/store
sudo chmod 755 "/nix/store/87qzdgr0fl4166yjhx11xhc64ncvzqxd-vscode-1.102.3/Applications/Visual Studio Code.app"
# Output: chmod: changing permissions of '...': Operation not permitted

# 3. iTerm2 WITH FDA - succeeds on /nix/store
sudo chmod 755 "/nix/store/87qzdgr0fl4166yjhx11xhc64ncvzqxd-vscode-1.102.3/Applications/Visual Studio Code.app"
# Result: Success (permissions changed from dr-xr-xr-x to drwxr-xr-x)
```

### Finding

Both sudo and launchd get "Operation not permitted" errors on `/nix/store` paths. The key difference:

- **Manual GC**: Runs in terminal with FDA → can chmod .app bundles
- **Automated GC**: launchd service without FDA → cannot chmod, fails with exit code 1

## Question 2: What's Full Disk Access actually doing?

### Investigation

```bash
# Check /nix filesystem mount
mount | grep "/nix"
# Output: /dev/disk3s7 on /nix (apfs, local, journaled, nobrowse, protect)
```

Note: "protect" flag, NOT read-only mount.

### Documentation Found

1. **FDA requirement** ([OS X Daily](https://osxdaily.com/2018/10/09/fix-operation-not-permitted-terminal-error-macos/)):
   - "If Terminal does not have Full Disk Access granted, you will see the 'Operation not permitted' error"

2. **System Integrity Protection** ([Apple Developer](https://developer.apple.com/library/archive/documentation/Security/Conceptual/System_Integrity_Protection_Guide/FileSystemProtections/FileSystemProtections.html)):
   - "SIP restricts the root user account and limits actions on protected parts"

3. **FDA limitations** ([Stack Overflow](https://stackoverflow.com/questions/58442951/how-to-fix-operation-not-permitted-when-i-use-launchctl-in-macos-catalina)):
   - Cannot be granted programmatically
   - Requires manual user action

### Finding

FDA allows bypassing the "protect" mount flag for chmod operations. However:

- No Apple documentation explicitly states this
- The mechanism remains unclear
- This behavior could change in future macOS versions

## Question 3: How do root-level GCs delete user configs?

### Investigation

```bash
# 1. Check traditional GC roots - empty!
ls -la /nix/var/nix/gcroots/per-user/
# Output: Empty directory (no user subdirectories)

# 2. Find Home Manager's actual location
ls -la ~/.local/state/home-manager/gcroots/current-home
# Points to: /nix/store/1aapq7qp2zk41jhiz0267hyznjja6zgp-home-manager-generation

# 3. Check indirect root registration
ls -la /nix/var/nix/gcroots/auto/ | grep current-home
# Output: 4vznz0n2bvc59pmzdqwgrd0627nbc9mf -> /Users/happygopher/.local/state/home-manager/gcroots/current-home

# 4. Find the broken reference
grep "p10k.zsh" ~/.config/zsh/.zim/init.zsh
# Contains: source "/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source/.../p10k.zsh"

# 5. Check if problematic path has roots
nix-store -q --roots /nix/store/mfkixld2qzjijisc847ppymyx53irisx-source
# Output: (empty - no roots!)
```

### Profile Types and GC Protection

Three profile types exist with different protection mechanisms:

| Profile Type | Location | GC Root | Protection |
|-------------|----------|---------|------------|
| System (nix-darwin) | `/nix/var/nix/profiles/system` | `/nix/var/nix/gcroots/current-system` | Direct root, always protected |
| User nix | `~/.local/state/nix/profiles/profile` | Auto/indirect via gcroots | Protected if profile exists |
| Home Manager | `~/.local/state/nix/profiles/home-manager` | `~/.local/state/home-manager/gcroots/current-home` | Generation protected, embedded paths NOT |

### Store References in User Configs

Comprehensive search revealed two categories:

```bash
# Count all /nix/store references
find ~/.config ~/.local ~/.cache -type l -exec ls -la {} \; | grep "/nix/store" | wc -l
# Output: 49 symlinks (protected)

find ~/.config -type f ! -type l -exec grep -l "/nix/store" {} \; | head -10
# Found files with embedded paths (vulnerable):
# ~/.config/zsh/.zim/init.zsh
# ~/.config/fontconfig/conf.d/10-hm-fonts.conf
# ~/.config/cheat/conf.yml
```

**Key insight**:

- **Symlinks** (49 found) → Protected by GC roots ✓
- **Embedded paths** in config files → NOT protected ✗

The critical path `/nix/store/mfkixld2qzjijisc847ppymyx53irisx-source` was:

- Referenced 5 times in `.zim/init.zsh`
- Had NO GC root
- Therefore deleted by system GC

### Finding

User configs are deleted because:

1. Home Manager generation itself IS rooted
2. But store paths INSIDE generated configs are NOT transitively protected
3. System GC sees these as unreachable and deletes them

## Question 4: Why the two-stage pattern?

### Analysis of Reproduction Sequence

From Story 1.3:

1. **First attempt**: launchd GC → chmod errors on .app bundles → exit code 1
2. **Manual GC**: With FDA → removed 10GB including .app bundles
3. **Second attempt**: launchd GC → no chmod errors → exit code 0

### launchd Service Details

```text
system/org.nixos.nix-gc = {
    program = /bin/sh
    arguments = /bin/sh -c '/bin/wait4path /nix/store && exec .../nix-collect-garbage'
    domain = system
    runs = 5
    last exit code = 0  # After manual GC cleared obstacles
}
```

### Finding

Two-stage pattern required because:

- **Stage 1**: Manual GC with FDA removes chmod-protected .app bundles
- **Stage 2**: launchd can complete without hitting chmod errors

## Answered Questions Summary

- **Why sudo vs launchd?**
  - *Answer*: Not about sudo vs launchd - it's about FDA vs no FDA
  - *Evidence*: chmod test results

- **FDA's role?**
  - *Answer*: Bypasses "protect" mount flag for chmod operations
  - *Evidence*: Empirical testing

- **How are user configs deleted?**
  - *Answer*: Missing transitive GC roots for embedded store paths
  - *Evidence*: No roots for deleted path

- **Why two-stage?**
  - *Answer*: Manual GC removes obstacles launchd can't handle
  - *Evidence*: 10GB freed, then success

## Unanswered Questions

### Home Manager Architecture

1. **Why use hardcoded store paths instead of indirection?**
   - Performance reasons?
   - Design oversight?
   - Known issue in Home Manager repo?

2. **How widespread is this pattern?**
   - Found in: ZIM, fontconfig, cheat configs
   - Which modules generate hardcoded paths?

### macOS Security Internals

1. **What exactly is the "protect" mount flag?**
   - No official Apple documentation found
   - Relationship to SIP unclear

2. **How does FDA bypass protection mechanisms?**
   - Undocumented behavior
   - Could change without notice

3. **Why only .app bundles need FDA for chmod?**
   - Regular files don't have this restriction
   - Related to code signing?

### Nix/macOS Integration

1. **Can launchd services get FDA?**
   - Current evidence: No
   - MDM/enterprise solutions?

2. **Who sets the "protect" flag on /nix?**
   - Nix installer or macOS?
   - Security implications?

## Recommendations for Epic 2

1. **Immediate**: Create proper GC roots for all embedded store paths
2. **Short-term**: Document FDA requirements for manual GC
3. **Long-term**: Investigate Home Manager's use of hardcoded paths
4. **Consider**: Using `mkOutOfStoreSymlink` for generated configs

## Conclusion

The investigation revealed that FDA is the key differentiator, not permissions between sudo and launchd. User configs are deleted due to missing transitive GC roots for store paths embedded in generated config files. The two-stage pattern works by having manual GC with FDA remove obstacles that block launchd.

While we answered QA's primary questions, several architectural questions about Home Manager design and macOS security internals remain open for future investigation.
